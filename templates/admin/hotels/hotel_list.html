{% extends "admin-base.html" %}
{% load static %}
{% load i18n %}

{% block title %}Hotels - List{% endblock %}

{% block layout %}
<!-- Basic Layout -->
<div class="card">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h5 class="card-header">Hotels</h5>
        </div>
        <div class="d-flex justify-content-end">
            <div class="d-flex align-items-center">
                <i class="ri-search-line ri-22px me-2"></i>
                <input type="text" id="search" class="form-control border-0 shadow-none bg-body" placeholder="Search hotels..."
                    aria-label="Search..." onkeyup="Pagination()" />
            </div>
            <a class="btn btn-primary waves-effect waves-light m-4" href="/stefi-admin-masters/hotels/add">Add Hotel</a>
        </div>
    </div>

    <div class="table-responsive text-nowrap">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>Sr No</th>
                    <th>Hotel Name</th>
                    <th>Owner</th>
                    <th>Contact</th>
                    <th>City</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody class="table-border-bottom-0" id="hotel_table_body">
                <!-- Data will be loaded here dynamically -->
            </tbody>
        </table>
        <div class="d-flex justify-content-end m-3" id="secondpagination-demo2">
            <ul id="pagination-demo2" class="pagination-sm"></ul>
        </div>
    </div>
</div>
{% endblock layout %}


{% block page_js %}
{{ block.super }}

<script>
    $(document).ready(function () {
        Pagination()
    });

    function Pagination() {
        $('#secondpagination-demo2').html('<ul id="pagination-demo2" class="pagination-sm"></ul>');
        get_table_data(1);
    }

    function get_table_data(p) {
        var search = $('#search').val() || '';
        var fd = new FormData();
        fd.append('search', search);
        fd.append('p', p);
        fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        $.ajax({
            url: hosturl + "/api/Masters/hotel_list_pagination_api",
            data: fd,
            headers: { "Authorization": "Bearer {{token}}" },
            type: 'POST',
            processData: false,
            contentType: false,
            beforeSend: function () {
                swal({
                    icon: "info",
                    title: "",
                    text: "Loading hotels...",
                    buttons: false,
                });
            },
            success: function (response) {
                swal.close();
                var infohtml = '';
                if (response.count != 0) {
                    var counter = parseInt(p + "1") - 10;

                    $.each(response.results, function (i, o) {
                        infohtml += `
                            <tr>
                                <td>${++counter}</td>
                                <td>${o.name || '-'}</td>
                                <td>${o.owner_name || '-'}</td>
                                <td>${o.contact_number || '-'}</td>
                                <td>${o.city || '-'}</td>
                                <td>
                                    <div class="dropdown">
                                        <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                                            <i class="ri-more-2-line"></i>
                                        </button>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item" href="/hotel/edit_hotel/${o.id}">
                                                <i class="ri-pencil-line me-1"></i> Edit
                                            </a>
                                            <a class="dropdown-item" href="javascript:void(0);" onclick="delete_hotel('${o.id}')">
                                                <i class="ri-delete-bin-6-line me-1"></i> Delete
                                            </a>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });

                    $('#hotel_table_body').html(infohtml);

                    var totalPages = Math.ceil(response.count / 10);
                    $('#pagination-demo2').twbsPagination({
                        totalPages: totalPages,
                        visiblePages: 3,
                        next: 'Next',
                        prev: 'Prev',
                        onPageClick: function (event, page) {
                            get_table_data(page);
                        }
                    });
                } else {
                    $('#hotel_table_body').html(`
                        <tr class="text-center">
                            <td colspan="6">No Hotels Found</td>
                        </tr>
                    `);
                    swal({
                        icon: "error",
                        title: "",
                        text: "No hotels found!",
                        button: "Close",
                    });
                }
            }
        });
    }

    function delete_hotel(id) {
        swal({
            title: "Are you sure?",
            text: "This will permanently delete the hotel record.",
            icon: "warning",
            buttons: true,
            dangerMode: true
        }).then((willDelete) => {
            if (willDelete) {
                $.ajax({
                    url: hosturl + "/api/Hotels/hotel_delete",
                    type: 'POST',
                    headers: { 'Authorization': 'Bearer {{token}}' },
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        'hotel_id': id
                    },
                    dataType: 'json',
                    success: function (response) {
                        if (response.response.n == 1) {
                            swal({
                                icon: "success",
                                title: "",
                                text: response.response.msg,
                                button: "Close",
                            }).then(() => {
                                Pagination();
                            });
                        } else {
                            swal({
                                icon: "error",
                                title: "",
                                text: response.response.msg,
                                button: "Close",
                            });
                        }
                    }
                });
            }
        });
    }
</script>
{% endblock page_js %}
