{% extends "base.html" %}
{% load static %}
{% block title %}{{ state }} — Explore & Plan | MyTravelSite{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="{% static 'assets/css/state-details.css'%}" />

{% endblock %}

{% block content %}
<!-- HERO -->
<section class="hero" aria-label="Hero">
    <div class="hero-slider" id="heroSlider">
        {% comment %} hero_images: list of image URLs {% endcomment %}
        {% if hero_images %}
        {% for img in hero_images %}
        <div class="hero-slide" style="background-image:url('{{ img }}')"></div>
        {% endfor %}
        {% else %}
        <div class="hero-slide" style="background-image:url('{% static 'default_hero.jpg' %}')"></div>
        {% endif %}
    </div>
    <div class="hero-overlay"></div>

    <div class="container hero-content">
        <div class="hero-breadcrumb">Home › Destinations › <strong>{{ state }}</strong></div>
        <h1 class="hero-title">{{ state }}</h1>
        <p class="hero-sub">{{ summary|default:"Discover places, experiences, and itineraries to plan your perfect  trip." }}</p>
    </div>

    <div class="hero-controls" id="heroDots"></div>
</section>

<!-- SUMMARY + INFO -->
<section class="summary-row page-wrapper">
    <div class="summary-card">
        <h3 style="margin-top:0">About {{ state|title }}</h3>
        <p style="color:var(--muted);line-height:1.6">{{ summary|default:"A beautiful place to explore." }}</p>

        <div style="margin-top:18px;display:flex;gap:12px;flex-wrap:wrap">
            {% for tag in tags %}
            <span
                style="background:#f2f9ff;padding:8px 12px;border-radius:18px;font-weight:600;color:#1b4762;font-size:13px">
                {{ tag }}
            </span>
            {% endfor %}

        </div>
    </div>

    <aside class="info-card">
        <div class="badge">Plan your trip</div>
        <!-- weather box -->
        
        <div style="display:flex;gap:14px;align-items:center">
            <div style="font-size:40px;font-weight:800;color:var(--accent)">{{ weather.temp_max|default:"--" }}°</div>
            <div>
                <div style="font-weight:700">{{ weather.today_text|default:"Clear" }}</div>
                <div class="meta-list">Min: {{ weather.temp_min|default:"--" }}° • Max: {{ weather.temp_max|default:"--"}}°</div>
            </div>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px solid rgba(20,30,40,0.06)">

        <div>
            <h4 style="margin:0 0 8px 0">Major Airports</h4>
            <ul style="margin:0;padding-left:18px;color:var(--muted)">
                {% for a in major_airports %}
                <li>{{ a }}</li>
                {% empty %}
                <li>Airport data unavailable</li>
                {% endfor %}
            </ul>

        </div>

        <div style="margin-top:12px;display:flex;gap:10px">
            <a class="tab-btn" href="#" style="flex:1;text-align:center;text-decoration:none;color:#c33">Share</a>
            <a class="tab-btn" href="#" style="flex:1;text-align:center;text-decoration:none">Save</a>
        </div>
    </aside>
</section>

<!-- ATTRACTIONS -->
<section class="section page-wrapper">
    <div class="section-head">
        <h2>Attractions</h2>
        <a href="#" style="color:var(--accent);font-weight:700;text-decoration:none">Discover more ›</a>
    </div>

    <div class="card-carousel" id="attractionsCarousel">
        {% for item in attractions %}
        <article class="attraction">
            <img src="{{ item.image }}" alt="{{ item.title }}">
            <div class="title">{{ item.title }}</div>
        </article>
        {% empty %}
        <div style="padding:20px;color:var(--muted)">No attractions available yet.</div>
        {% endfor %}
    </div>
</section>

<!-- EXPERIENCES -->
<section class="experiences page-wrapper">
    <div class="">
        <div style="text-align:center;margin-bottom:22px">
            <h2 style="margin:0">Experiences</h2>
            <p style="color:var(--muted)">Unique local experiences that make {{ state }} special</p>
        </div>

        <div class="exp-grid">
            {% for e in experiences %}
            <div class="exp-card">
                <img src="{{ e.image }}" alt="{{ e.title }}">
                <h4>{{ e.title }}</h4>
                <div style="color:var(--muted);font-size:14px">{{ e.subtitle }}</div>
                <div style="margin-top:auto">
                    <a href="{{ e.link }}"
                        style="display:inline-block;margin-top:10px;padding:8px 12px;background:var(--accent);color:#fff;border-radius:8px;text-decoration:none;font-weight:700">Explore</a>
                </div>
            </div>
            {% empty %}
            <div style="color:var(--muted)">No experiences listed.</div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- ITINERARIES -->
<section class="itineraries page-wrapper">
    <div class="" style="text-align:center;margin-bottom:18px">
        <h2>Itineraries</h2>
        <p style="color:var(--muted)">Suggested trip plans for different trip lengths</p>
    </div>

    <div class="it-grid">
        {% for it in itineraries %}
        <div class="it-item">
            <img src="{{ it.image }}" alt="{{ it.title }}">
            <div style="padding:10px 6px">
                <div class="days">{{ it.days }} Days</div>
                <h3 style="margin:8px 0 6px 0;font-size:18px">{{ it.title }}</h3>
                <p style="color:var(--muted);font-size:14px">{{ it.desc }}</p>
                <a href="{{ it.link }}"
                    style="display:inline-block;margin-top:10px;color:var(--accent);font-weight:700;text-decoration:none">View
                    itinerary →</a>
            </div>
        </div>
        {% empty %}
        <div style="color:var(--muted)">No itineraries available.</div>
        {% endfor %}
    </div>
</section>

<!-- MAP -->
<section class="map-section page-wrapper">
    <div class="map-panel">
        <aside class="map-sidebar">
            <h4 style="margin-top:0">Explore {{ state }}</h4>
            <div class="map-tabs">
                <button class="tab-btn active" data-layer="poi">Points of interest</button>
                <button class="tab-btn" data-layer="atms">ATMs</button>
                <button class="tab-btn" data-layer="police">Police Stations</button>
                <button class="tab-btn" data-layer="health">Health Facilities</button>
            </div>

            <div style="margin-top:14px">
                <label style="font-size:13px;color:var(--muted)">Search</label>
                <input id="mapSearch" placeholder="Search places, hotels..."
                    style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(10,20,30,0.06);margin-top:8px">
            </div>
        </aside>

        <div id="map" role="application" aria-label="Map of {{ state }}"></div>
    </div>
</section>

<!-- NEARBY DESTINATIONS -->
<section class="nearby  page-wrapper">
    <div class="container" style="display:flex;align-items:center;justify-content:space-between">
        <h2 style="margin:0">Destinations Nearby</h2>
        <a href="#" style="color:var(--accent);font-weight:700;text-decoration:none">See all</a>
    </div>

    <div class="nearby-grid">
        {% for n in nearby %}
        <a class="nearby-card" href="{{ n.link }}">
            <img src="{{ n.image }}" alt="{{ n.title }}">
            <p>{{ n.title }}</p>
        </a>
        {% empty %}
        <div style="color:var(--muted);padding:16px">No nearby destinations found.</div>
        {% endfor %}
    </div>
</section>


{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    /* ---------- HERO SLIDER ---------- */
    (function () {
        const slider = document.getElementById('heroSlider');
        const slides = slider.children;
        const dotsContainer = document.getElementById('heroDots');
        const total = slides.length;
        let idx = 0;
        if (total <= 1) {
            // hide controls
            dotsContainer.style.display = 'none';
            return;
        }
        for (let i = 0; i < total; i++) {
            const d = document.createElement('button');
            d.className = 'hero-dot' + (i === 0 ? ' active' : '');
            d.dataset.i = i;
            d.addEventListener('click', () => goTo(i));
            dotsContainer.appendChild(d);
        }
        function goTo(i) {
            idx = i;
            slider.style.transform = `translateX(-${i * 100}%)`;
            [...dotsContainer.children].forEach((b, bi) => b.classList.toggle('active', bi === i));
        }
        // auto-advance every 5s
        let t = setInterval(() => goTo((idx + 1) % total), 5000);
        // pause on hover
        slider.addEventListener('mouseenter', () => clearInterval(t));
        slider.addEventListener('mouseleave', () => t = setInterval(() => goTo((idx + 1) % total), 5000));
    })();

    /* ---------- SIMPLE CAROUSEL DRAG FOR ATTRACTIONS ---------- */
    (function () {
        const carousel = document.getElementById('attractionsCarousel');
        if (!carousel) return;
        let pressed = false, startX, scrollLeft;
        carousel.addEventListener('mousedown', (e) => { pressed = true; carousel.classList.add('dragging'); startX = e.pageX - carousel.offsetLeft; scrollLeft = carousel.scrollLeft });
        window.addEventListener('mouseup', () => { pressed = false; carousel.classList.remove('dragging') });
        carousel.addEventListener('mousemove', (e) => { if (!pressed) return; e.preventDefault(); const x = e.pageX - carousel.offsetLeft; const walk = (x - startX); carousel.scrollLeft = scrollLeft - walk; });
    })();

    /* ---------- MAP ---------- */
(function () {
    const defaultCenter = {
        lat: {{ map_center.lat|default:20.5937 }},
        lng: {{ map_center.lng|default:78.9629 }},
        zoom: {{ map_center.zoom|default:6 }}
    };






    const map = L.map('map').setView([defaultCenter.lat, defaultCenter.lng], defaultCenter.zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    // Add a primary marker at center
    const centerMarker = L.circleMarker([defaultCenter.lat, defaultCenter.lng], { radius: 6, fillColor: '#e33b3b', color: '#fff', weight: 2, fillOpacity: 1 }).addTo(map);

    // Basic POI layer (example points from attractions)
    const poiData = [
        {% for a in attractions %}
        { 
            title: "{{ a.title|escapejs }}",
            lat: {{ a.lat|default:map_center.lat }},
            lng: {{ a.lng|default:map_center.lng }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];


    const poiLayer = L.layerGroup();
    poiData.forEach(p => {
        if (p.lat && p.lng) {
            const m = L.marker([p.lat, p.lng]).bindPopup(`<strong>${p.title}</strong>`);
            poiLayer.addLayer(m);
        }
    });
    poiLayer.addTo(map);

    // Map tab switching — just toggles which layer is visible (expand with real data)
    document.querySelectorAll('.map-tabs .tab-btn').forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelectorAll('.map-tabs .tab-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            const layer = this.dataset.layer;
            // demo behaviour: if 'poi' show markers, else clear and show center only
            if (layer === 'poi') {
                if (!map.hasLayer(poiLayer)) poiLayer.addTo(map);
            } else {
                if (map.hasLayer(poiLayer)) map.removeLayer(poiLayer);
            }
        });
    });

    // Search box: just zooms to center for now (placeholder for geocoding)
    document.getElementById('mapSearch').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
            const q = this.value.trim();
            if (!q) return;
            alert('Search placeholder — implement geocoding for: ' + q);
        }
    });

}) ();
</script>
{% endblock %}