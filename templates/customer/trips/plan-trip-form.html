{% extends 'base.html' %}

{% load static %}



{% block title %}Plan New Trip - Stefi Travel{% endblock %}



{% block extra_css %}
    <style>
        :root {
            --primary-color: #057b93;
            --secondary-color: #11ccf1;
            --accent-color: #ff6b6b;
            --light-bg: #f8fafc;
            --dark-text: #2c3e50;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--dark-text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .planning-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            padding: 25px;
            margin-bottom: 25px;
            transition: transform 0.3s ease;
        }
        
        .planning-card:hover {
            transform: none; /* Removed hover effect for consistency when dynamic content is loaded */
        }
        
        .section-title {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .budget-card {
            background: linear-gradient(135deg, #10c6ea 0%, #068099 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .day-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
        }
        
        .transport-card {
            text-align: center;
            padding: 15px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            height: 100%;
        }
        
        .transport-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .ai-suggestion {
            background: #f1f9ff;
            border-left: 4px solid var(--secondary-color);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        
        .packing-list {
            list-style-type: none;
            padding: 0;
        }
        
        .packing-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .packing-list li:before {
            content: "â€¢";
            color: var(--secondary-color);
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
        }
        
        .cost-breakdown {
            width: 100%;
            margin-top: 15px;
        }
        
        .cost-breakdown tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .cost-breakdown tr:last-child {
            border-bottom: none;
            font-weight: bold;
        }
        
        .big-btn {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            border: none;
            border-radius: 12px;
            padding: 12px 25px;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 113, 254, 0.3);
            color: white;
        }
        
        .big-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 113, 254, 0.4);
        }
        
        .form-control, .form-select {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(17, 204, 241, 0.15);
        }
        
        .date-badge {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Autocomplete dropdown styles */
        .autocomplete-container {
            position: relative;
        }
        
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .autocomplete-item:hover {
            background-color: #f8f9fa;
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        .location-icon {
            width: 20px;
            text-align: center;
            margin-right: 8px;
            color: var(--primary-color);
        }

        /* Skeleton Loader Styles */
        .skeleton {
            animation: pulse 1.5s infinite ease-in-out;
            background: linear-gradient(-90deg, #f0f0f0 0%, #f8f8f8 50%, #f0f0f0 100%);
            background-size: 400% 400%;
            border-radius: 8px;
        }
        .skeleton-text {
            height: 12px;
            margin: 5px 0;
        }
        .skeleton-row {
            height: 40px;
            margin-bottom: 10px;
        }
        .skeleton-suggestion {
            height: 50px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        @keyframes pulse {
            0% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .placeholder-output {
            opacity: 0.7;
        }
        
        @media (max-width: 768px) {
            .transport-card {
                margin-bottom: 15px;
            }
        }
    </style>
{% endblock %}



{% block content %}
    <div class="container dashboard-container pt-5 mt-5">
        <div class="row mt-5">
            <!-- Left Column -->
            <div class="col-lg-8">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="/">Home</a></li>
                                <li class="breadcrumb-item active" aria-current="page">AI Trip Planner</li>
                            </ol>
                        </nav>
                        <h2 class="mb-0">AI Trip Planner</h2>
                    </div>
                    <!-- Export button visible only if a plan exists -->
                    <button id="exportPlanBtn" class="big-btn" style="display:none;"><i class="fas fa-download me-2"></i> Export Plan</button>
                </div>

                <!-- Trip Planning Card (Input Form) -->
                <div class="planning-card">
                    <h4 class="section-title">Plan Your Trip</h4>
                    <form id="aiPlanForm">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Plan Name / City</label>
                                <div class="autocomplete-container">
                                    <input type="text" id="plan_name" class="form-control" value="" placeholder="E.g., Pune to Agra Trip" required>
                                    <div id="plan_name_autocomplete" class="autocomplete-dropdown"></div>
                                </div>
                                <div class="mt-1">
                                    <button type="button" id="getCurrentLocation" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-location-arrow me-1"></i> Use Current Location
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Destination</label>
                                <div class="autocomplete-container">
                                    <input type="text" id="destination" class="form-control" value="" placeholder="Enter destination city" required>
                                    <div id="destination_autocomplete" class="autocomplete-dropdown"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Budget (INR/USD)</label>
                                <input type="number" id="budget" class="form-control" value="" required min="100">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Start Date</label>
                                <input type="date" id="start_date" class="form-control" value="" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">End Date</label>
                                <input type="date" id="end_date" class="form-control" value="" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Trip Duration</label>
                                <input type="text" id="tripDuration" class="form-control" value="" disabled>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Peoples</label>
                                <input type="number" id="peoples" class="form-control" value="" required min="1">
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button type="submit" id="generatePlanBtn" class="big-btn">
                                <i class="fas fa-magic me-2"></i> Generate AI Plan
                            </button>
                        </div>
                    </form>
                </div>

                <!-- AI Suggestions (Dynamic Content) -->
                <div id="aiSuggestionsContainer" class="planning-card" style="display: none;">
                    <h4 class="section-title">AI Suggestions</h4>
                    <div id="aiSuggestionsList">
                        <!-- AI Suggestions will be injected here -->
                    </div>
                </div>

                <!-- Itinerary (Dynamic Content) -->
                <div id="itineraryContainer" class="planning-card" style="display: none;">
                    <h4 class="section-title">Your Itinerary</h4>
                    <div id="itineraryList" style="max-height: 70vh;overflow-y: auto;">
                        <!-- Day cards will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-lg-4">
                
                <!-- Budget Summary (Dynamic Content) -->
                <div id="budgetSummaryContainer" class="budget-card" style="display: none;">
                    <h4 class="text-white">Budget Summary</h4>
                    <table class="cost-breakdown">
                        <tbody id="budgetBreakdown">
                            <!-- Budget rows will be injected here -->
                        </tbody>
                    </table>
                </div>

                <!-- Transport Options (Dynamic Content) -->
                <div id="transportOptionsContainer" class="planning-card" style="display: none;">
                    <h4 class="section-title">Transport Options</h4>
                    <div class="row" id="transportOptionsList">
                        <!-- Transport cards will be injected here -->
                    </div>
                </div>

                <!-- Packing List (Dynamic Content) -->
                <div id="packingListContainer" class="planning-card" style="display: none;">
                    <h4 class="section-title">Packing List</h4>
                    <ul class="packing-list" id="packingList">
                        <!-- Packing list items will be injected here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% endblock %}



{% block extra_js %}
<script>
    // --- Configuration ---
    const API_HOST = "{{hosturl}}"; 
    const AI_PLAN_API = `/api/trips/ai_trip_plan_view`;
    
    // Popular Indian cities and destinations for autocomplete
    const POPULAR_DESTINATIONS = [
        "Mumbai, Maharashtra", "Delhi", "Bangalore, Karnataka", "Hyderabad, Telangana",
        "Chennai, Tamil Nadu", "Kolkata, West Bengal", "Pune, Maharashtra", "Ahmedabad, Gujarat",
        "Jaipur, Rajasthan", "Lucknow, Uttar Pradesh", "Kanpur, Uttar Pradesh", "Nagpur, Maharashtra",
        "Indore, Madhya Pradesh", "Thane, Maharashtra", "Bhopal, Madhya Pradesh", "Visakhapatnam, Andhra Pradesh",
        "Patna, Bihar", "Vadodara, Gujarat", "Ghaziabad, Uttar Pradesh", "Ludhiana, Punjab",
        "Agra, Uttar Pradesh", "Nashik, Maharashtra", "Faridabad, Haryana", "Meerut, Uttar Pradesh",
        "Rajkot, Gujarat", "Kalyan-Dombivli, Maharashtra", "Vasai-Virar, Maharashtra", "Varanasi, Uttar Pradesh",
        "Srinagar, Jammu & Kashmir", "Aurangabad, Maharashtra", "Dhanbad, Jharkhand", "Amritsar, Punjab",
        "Goa", "Manali, Himachal Pradesh", "Shimla, Himachal Pradesh", "Darjeeling, West Bengal",
        "Ooty, Tamil Nadu", "Munnar, Kerala", "Kochi, Kerala", "Kodaikanal, Tamil Nadu",
        "Leh, Ladakh", "Rishikesh, Uttarakhand", "Haridwar, Uttarakhand", "Varkala, Kerala",
        "Pondicherry", "Andaman and Nicobar Islands", "Lakshadweep", "Kashmir"
    ];

    // --- Helper Functions ---

    // Utility to show Bootstrap Toasts
    function showToast(title, message, type = 'info') {
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type} border-0 position-fixed bottom-0 end-0 m-3" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${title}:</strong> ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>`;
        
        const toastEl = $(toastHtml);
        $('body').append(toastEl);
        const bsToast = new bootstrap.Toast(toastEl[0]);
        bsToast.show();
        
        toastEl.on('hidden.bs.toast', function () {
            $(this).remove();
        });
    }

    // Function to calculate and display trip duration
    function calculateDuration() {
        const startDateVal = $('#start_date').val();
        const endDateVal = $('#end_date').val();
        
        if (startDateVal && endDateVal) {
            const startDate = new Date(startDateVal);
            const endDate = new Date(endDateVal);
            
            if (startDate > endDate) {
                $('#tripDuration').val('Invalid Dates');
                return 0;
            }

            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            $('#tripDuration').val(diffDays + ' days');
            return diffDays;
        } else {
            $('#tripDuration').val('0 days');
            return 0;
        }
    }
    
    // Autocomplete functionality
    function initializeAutocomplete(inputId, dropdownId) {
        const input = $(`#${inputId}`);
        const dropdown = $(`#${dropdownId}`);
        
        input.on('input', function() {
            const query = $(this).val().toLowerCase();
            
            if (query.length < 2) {
                dropdown.hide();
                return;
            }
            
            const filtered = POPULAR_DESTINATIONS.filter(dest => 
                dest.toLowerCase().includes(query)
            );
            
            if (filtered.length > 0) {
                const suggestionsHtml = filtered.map(dest => `
                    <div class="autocomplete-item" data-value="${dest}">
                        <i class="fas fa-map-marker-alt location-icon"></i>
                        ${dest}
                    </div>
                `).join('');
                
                dropdown.html(suggestionsHtml).show();
            } else {
                dropdown.hide();
            }
        });
        
        // Handle click on autocomplete items
        dropdown.on('click', '.autocomplete-item', function() {
            const value = $(this).data('value');
            input.val(value);
            dropdown.hide();
        });
        
        // Hide dropdown when clicking outside
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.autocomplete-container').length) {
                dropdown.hide();
            }
        });
        
        // Keyboard navigation
        input.on('keydown', function(e) {
            const items = dropdown.find('.autocomplete-item');
            const activeItem = dropdown.find('.autocomplete-item.active');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (activeItem.length === 0) {
                    items.first().addClass('active');
                } else {
                    activeItem.removeClass('active').next().addClass('active');
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (activeItem.length === 0) {
                    items.last().addClass('active');
                } else {
                    activeItem.removeClass('active').prev().addClass('active');
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const selected = dropdown.find('.autocomplete-item.active');
                if (selected.length) {
                    input.val(selected.data('value'));
                    dropdown.hide();
                }
            }
        });
    }
    
    // Get current location using browser's Geolocation API
    function getCurrentLocation() {
        if (!navigator.geolocation) {
            showToast('Error', 'Geolocation is not supported by your browser', 'warning');
            return;
        }
        
        $('#getCurrentLocation').html('<i class="fas fa-spinner fa-spin me-1"></i> Detecting...').prop('disabled', true);
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Use a geocoding service to get city name
                reverseGeocode(lat, lng);
            },
            function(error) {
                let errorMessage = 'Unable to retrieve your location';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'Location access denied. Please enable location permissions.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'Location information unavailable.';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'Location request timed out.';
                        break;
                }
                showToast('Location Error', errorMessage, 'warning');
                $('#getCurrentLocation').html('<i class="fas fa-location-arrow me-1"></i> Use Current Location').prop('disabled', false);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    }
    
    // Reverse geocode coordinates to get city name
    function reverseGeocode(lat, lng) {
        // Using OpenStreetMap Nominatim API (free, no API key required)
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10`;
        
        $.ajax({
            url: url,
            type: 'GET',
            success: function(data) {
                let cityName = '';
                
                if (data.address) {
                    // Try to get city name from different possible fields
                    cityName = data.address.city || 
                              data.address.town || 
                              data.address.village || 
                              data.address.county ||
                              data.address.state;
                    
                    if (cityName) {
                        $('#plan_name').val(cityName);
                        showToast('Success', `Location set to ${cityName}`, 'success');
                    } else {
                        showToast('Info', 'Could not determine city name from location', 'info');
                    }
                } else {
                    showToast('Error', 'Could not determine location name', 'warning');
                }
                
                $('#getCurrentLocation').html('<i class="fas fa-location-arrow me-1"></i> Use Current Location').prop('disabled', false);
            },
            error: function() {
                showToast('Error', 'Failed to get location name', 'warning');
                $('#getCurrentLocation').html('<i class="fas fa-location-arrow me-1"></i> Use Current Location').prop('disabled', false);
            }
        });
    }
    
    // --- Rendering Functions ---

    function showLoadingState() {
        $('#generatePlanBtn').html('<i class="fas fa-spinner fa-spin me-2"></i> Generating Plan...');
        $('#generatePlanBtn').prop('disabled', true);
        $('#exportPlanBtn').hide();

        // Show all containers with skeleton content
        const outputContainers = [
            '#itineraryContainer', '#aiSuggestionsContainer', 
            '#budgetSummaryContainer', '#transportOptionsContainer', 
            '#packingListContainer'
        ];
        
        // Use a simple skeleton HTML structure for each section
        const skeletonText = '<div class="skeleton-text skeleton w-75"></div><div class="skeleton-text skeleton w-50"></div>';
        
        $('#aiSuggestionsList').html(
            '<div class="ai-suggestion placeholder-output"><div class="skeleton-suggestion skeleton"></div></div>'.repeat(3)
        );
        $('#itineraryList').html(
            '<div class="day-card placeholder-output"><div class="skeleton-row skeleton w-50 mb-3"></div>' +
            '<table class="table"><tr><td><div class="skeleton-row skeleton w-75"></div></td></tr><tr><td><div class="skeleton-row skeleton w-90"></div></td></tr></table></div>'.repeat(2)
        );
        $('#budgetBreakdown').html(
            '<tr><td><div class="skeleton-text skeleton w-50"></div></td><td class="text-end"><div class="skeleton-text skeleton w-50"></div></td></tr>'.repeat(4) +
            '<tr><td><div class="skeleton-text skeleton w-75"></div></td><td class="text-end"><div class="skeleton-text skeleton w-50"></div></td></tr>'
        );
        $('#transportOptionsList').html(
            '<div class="col-md-12 mb-3"><div class="transport-card placeholder-output"><div class="skeleton-row skeleton w-25 mx-auto mb-2"></div><div class="skeleton-text skeleton w-50 mx-auto"></div><div class="skeleton-text skeleton w-30 mx-auto"></div><div class="skeleton-text skeleton w-40 mx-auto mt-2"></div></div></div>'.repeat(2)
        );
        $('#packingList').html(
            '<li><div class="skeleton-text skeleton w-75"></div></li>'.repeat(4)
        );

        outputContainers.forEach(id => $(id).show());
    }

    function hideLoadingState(originalText) {
        $('#generatePlanBtn').html(originalText);
        $('#generatePlanBtn').prop('disabled', false);
    }
    
    function clearOutputContainers() {
        $('#aiSuggestionsContainer, #itineraryContainer, #budgetSummaryContainer, #transportOptionsContainer, #packingListContainer').hide();
        $('#aiSuggestionsList, #itineraryList, #budgetBreakdown, #transportOptionsList, #packingList').empty();
        $('#exportPlanBtn').hide();
    }

    function renderTripPlan(plan) {
        // 1. Render AI Suggestions
        const suggestionsHtml = plan.ai_suggestions.map(suggestion => 
            `<div class="ai-suggestion"><i class="fas fa-lightbulb text-warning me-2"></i> ${suggestion}</div>`
        ).join('');
        $('#aiSuggestionsList').html(suggestionsHtml);

        // 2. Render Budget Summary
        const budget = plan.budget_summary;
        const budgetHtml = `
            <tr><td>Travel</td><td class="text-end">${budget.travel}</td></tr>
            <tr><td>Stay</td><td class="text-end">${budget.stay}</td></tr>
            <tr><td>Food</td><td class="text-end">${budget.food}</td></tr>
            <tr><td>Activities</td><td class="text-end">${budget.activities}</td></tr>
            <tr class="fw-bold"><td>Grand Total</td><td class="text-end">${budget.grand_total}</td></tr>
        `;
        $('#budgetBreakdown').html(budgetHtml);

        // 3. Render Transport Options
        const transportHtml = plan.transport_options.map(opt => `
            <div class="col-md-12 mb-3">
                <div class="transport-card">
                    <i class="fas ${opt.icon} fa-2x text-primary mb-2"></i>
                    <h5>${opt.type}</h5>
                    <div class="mb-2">
                        <div class="fw-bold">${opt.price}</div>
                        <small>Price (one way)</small>
                    </div>
                    <div>
                        <div class="fw-bold">${opt.duration}</div>
                        <small>Duration</small>
                    </div>
                </div>
            </div>
        `).join('');
        $('#transportOptionsList').html(transportHtml);

        // 4. Render Itinerary
        const itineraryHtml = plan.itinerary.map(day => {
            const activitiesHtml = day.activities.map(activity => `
                <tr>
                    <td>${activity.category}</td>
                    <td>${activity.details}</td>
                    <td class="text-end">${activity.cost}</td>
                </tr>
            `).join('');
            
            return `
                <div class="day-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">${day.title}</h5>
                        <span class="date-badge big-btn">${day.date}</span>
                    </div>
                    <p class="text-muted">${day.description}</p>
                    <table class="table">
                        <tr>
                            <th style="width: 25%;">Category</th>
                            <th style="width: 50%;">Details</th>
                            <th class="text-end" style="width: 25%;">Cost</th>
                        </tr>
                        ${activitiesHtml}
                        <tr class="fw-bold">
                            <td colspan="2">Day Total</td>
                            <td class="text-end">${day.day_total}</td>
                        </tr>
                    </table>
                </div>
            `;
        }).join('');
        $('#itineraryList').html(itineraryHtml);

        // 5. Render Packing List
        const packingHtml = plan.packing_list.map(item => `<li>${item}</li>`).join('');
        $('#packingList').html(packingHtml);

        // Show all containers
        $('#aiSuggestionsContainer, #itineraryContainer, #budgetSummaryContainer, #transportOptionsContainer, #packingListContainer').slideDown(400);
        $('#exportPlanBtn').show(); // Show export button now that plan is available
    }

    // --- Main Logic ---

    $(document).ready(function() {
        // Remove floating search bar (as in original template)
        
        // Initial setup for date min limits
        const today = new Date().toISOString().split('T')[0];
        $('#start_date').attr('min', today);
        $('#end_date').attr('min', today);
        
        // Calculate trip duration on load and change
        calculateDuration();
        $('#start_date, #end_date').on('change', calculateDuration);
        
        // Set end date minimum based on start date
        $('#start_date').on('change', function() {
            $('#end_date').attr('min', $(this).val());
        });
        
        // Initialize autocomplete for both fields
        initializeAutocomplete('plan_name', 'plan_name_autocomplete');
        initializeAutocomplete('destination', 'destination_autocomplete');
        
        // Current location button event
        $('#getCurrentLocation').on('click', getCurrentLocation);
        
        // Try to auto-detect location on page load (with user permission)
        setTimeout(() => {
            // Only auto-detect if the field is empty
            if (!$('#plan_name').val()) {
                getCurrentLocation();
            }
        }, 1000);

        // --- API INTEGRATION ---

        $('#aiPlanForm').on('submit', function(e) {
            e.preventDefault();
            
            // Basic validation check
            let isValid = true;
            $('.form-control:required').each(function() {
                if (!$(this).val().trim()) {
                    $(this).addClass('is-invalid');
                    isValid = false;
                } else {
                    $(this).removeClass('is-invalid');
                }
            });
            
            if (!isValid) {
                showToast('Error', 'Please fill all required fields correctly.', 'danger');
                return;
            }

            const days = calculateDuration();
            if (days === 0) {
                 showToast('Error', 'Please ensure the start date is before or the same as the end date.', 'danger');
                 return;
            }

            // Prepare API data payload
            const formData = {
                'start_location': $('#plan_name').val(),
                'destination': $('#destination').val(),
                // FIX: Parse budget as integer
                'budget': parseInt($('#budget').val(), 10),
                'start_date': $('#start_date').val(),
                'end_date': $('#end_date').val(),
                // FIX: Parse people as integer
                'people': parseInt($('#peoples').val(), 10),
                'trip_duration': days 
                // Add any other necessary fields for the backend AI view
            };
            
            const submitBtn = $('#generatePlanBtn');
            const originalText = submitBtn.html();
            
            clearOutputContainers();
            showLoadingState();

            // Send AJAX request to the AI Trip Plan endpoint
            $.ajax({
                url: AI_PLAN_API,
                type: 'POST',
                // Assuming CSRF token is required and available in the template context
                headers: {
                    'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
                },
                data: JSON.stringify(formData),
                contentType: 'application/json',
                dataType: 'json',
                success: function(response) {
                    if (response.success && response.trip_plan) {
                        showToast('Success', 'AI plan generated successfully!', 'success');
                        renderTripPlan(response.trip_plan);
                    } else {
                        // Handle success: false or missing trip_plan structure
                        showToast('Warning', response.message || 'AI could not generate a plan with the given constraints.', 'warning');
                    }
                },
                error: function(xhr) {
                    let errorMessage = 'Failed to generate plan. Server error.';
                    
                    // Attempt to get a more specific error message from the response body (common in DRF)
                    if (xhr.responseJSON) {
                        if (xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (xhr.responseJSON.detail) {
                            errorMessage = xhr.responseJSON.detail;
                        } else {
                            // Serialize complex error objects (like Django Rest Framework field validation errors)
                            try {
                                errorMessage = JSON.stringify(xhr.responseJSON, null, 2);
                            } catch (e) {
                                // Fallback if serialization fails
                                errorMessage = 'Invalid input data. Please check your fields.';
                            }
                        }
                    } else if (xhr.status === 400) {
                        errorMessage = 'Invalid input data. Please check your fields.';
                    } else if (xhr.responseText) {
                         // Fallback for non-JSON response text
                         errorMessage = `Server Error (${xhr.status}): ${xhr.responseText.substring(0, 100)}...`;
                    }
                    
                    showToast('Error', errorMessage, 'danger');
                    clearOutputContainers();
                },
                complete: function() {
                    hideLoadingState(originalText);
                }
            });
        });
        
        // Placeholder for Export functionality (can be implemented as another API call later)
        $('#exportPlanBtn').on('click', function() {
            showToast('Export', 'Preparing plan for export...', 'info');
            // Logic to fetch or prepare the downloadable file goes here
        });

    });

</script>
{% endblock %}